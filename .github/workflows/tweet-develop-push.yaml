name: Tweet Develop Push

on:
  push:
    branches:
      - develop

jobs:
  tweet_develop_push:
    runs-on: ubuntu-latest
    env:
      X_APP_API_KEY:             ${{ secrets.X_APP_API_KEY }}
      X_APP_API_KEY_SECRET:      ${{ secrets.X_APP_API_KEY_SECRET }}
      X_BOT_ACCESS_TOKEN:        ${{ secrets.X_BOT_ACCESS_TOKEN }}
      X_BOT_ACCESS_TOKEN_SECRET: ${{ secrets.X_BOT_ACCESS_TOKEN_SECRET }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # 直前のコミットと比較するために2コミット取得

    - name: Check if version update commit
      id: check_commit
      run: |
        # 最新のコミットタイトル（1行目のみ）を取得
        COMMIT_TITLE=$(git log -1 --pretty=%s)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        echo "Commit title: $COMMIT_TITLE"
        echo "Commit author: $COMMIT_AUTHOR"

        SHOULD_SKIP=false

        # バージョン更新コミットかどうかをチェック（vX.X.X形式のみ）
        if echo "$COMMIT_TITLE" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "This is a version update commit. Skipping tweet."
          SHOULD_SKIP=true
        fi

        # dependabotからのコミットかどうかをチェック
        if echo "$COMMIT_AUTHOR" | grep -qi "dependabot"; then
          echo "This is a dependabot commit. Skipping tweet."
          SHOULD_SKIP=true
        fi

        # dependabot関連のコミットメッセージかどうかをチェック
        if echo "$COMMIT_TITLE" | grep -qE '^chore\(deps(-dev)?\):'; then
          echo "This is a dependency update commit. Skipping tweet."
          SHOULD_SKIP=true
        fi

        if [ "$SHOULD_SKIP" = true ]; then
          echo "should_tweet=false" >> "$GITHUB_OUTPUT"
        else
          echo "should_tweet=true" >> "$GITHUB_OUTPUT"
          echo "This commit should be tweeted."
        fi

    - name: Setup Node.js
      if: steps.check_commit.outputs.should_tweet == 'true'
      uses: actions/setup-node@v6
      with:
        node-version: 22.x

    - name: Setup pnpm
      if: steps.check_commit.outputs.should_tweet == 'true'
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Install dependencies
      if: steps.check_commit.outputs.should_tweet == 'true'
      run: pnpm install

    - name: Generate tweet content
      if: steps.check_commit.outputs.should_tweet == 'true'
      id: generate_tweet
      run: |
        # コミット情報を取得
        COMMIT_HASH=$(git rev-parse --short HEAD)
        COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        HASH_TAGS="#艦これウィジェット"

        # ツイート本文を生成（280文字制限を考慮）
        # printf を使って複数行テキストを生成（heredoc より安全）
        TWEET_TEXT=$(printf "%s\n%s\n%s" "${COMMIT_MSG}" "${COMMIT_URL}" "${HASH_TAGS}")

        # 280文字を超える場合はコミットメッセージを切り詰め
        if [ ${#TWEET_TEXT} -gt 280 ]; then
          MAX_MSG_LEN=$((280 - 100))  # URL等の固定部分を除いた長さ
          COMMIT_MSG_SHORT=$(echo "$COMMIT_MSG" | cut -c1-$MAX_MSG_LEN)
          TWEET_TEXT=$(printf "%s...\n%s\n%s" "${COMMIT_MSG_SHORT}" "${COMMIT_URL}" "${HASH_TAGS}")
        fi

        # GitHub Actionsの出力に設定
        {
          echo "tweet_text<<EOF"
          echo "$TWEET_TEXT"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Post tweet
      if: steps.check_commit.outputs.should_tweet == 'true'
      run: |
        pnpm exec tsx scripts/post-tweet.ts "${{ steps.generate_tweet.outputs.tweet_text }}"
