name: Tweet New Pull Request

on:
  pull_request_target:
    types: [opened]
    branches:
      - develop

jobs:
  tweet_new_pr:
    runs-on: ubuntu-latest
    env:
      X_APP_API_KEY:             ${{ secrets.X_APP_API_KEY }}
      X_APP_API_KEY_SECRET:      ${{ secrets.X_APP_API_KEY_SECRET }}
      X_BOT_ACCESS_TOKEN:        ${{ secrets.X_BOT_ACCESS_TOKEN }}
      X_BOT_ACCESS_TOKEN_SECRET: ${{ secrets.X_BOT_ACCESS_TOKEN_SECRET }}
    steps:
    - uses: actions/checkout@v5
      with:
        ref: develop

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: 22.x

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Install dependencies
      run: pnpm install

    - name: Generate tweet content
      id: generate_tweet
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_URL: ${{ github.event.pull_request.html_url }}
        PR_USER: ${{ github.event.pull_request.user.login }}
      run: |
        HASH_TAGS="#艦これウィジェット"

        # ツイート本文を生成（280文字制限を考慮）
        # 感謝メッセージを含める
        TWEET_TEXT=$(printf "#%s %s\n%sさんありがとうございます!\n%s\n%s" "${PR_NUMBER}" "${PR_TITLE}" "${PR_USER}" "${PR_URL}" "${HASH_TAGS}")

        # 280文字を超える場合はタイトルを切り詰め
        if [ ${#TWEET_TEXT} -gt 280 ]; then
          # URL等の固定部分の長さを計算（感謝メッセージ + URL + ハッシュタグ + ユーザー名）
          # 余裕を見て150文字を固定部分として確保
          MAX_TITLE_LEN=$((280 - 150))
          PR_TITLE_SHORT=$(echo "$PR_TITLE" | cut -c1-$MAX_TITLE_LEN)
          TWEET_TEXT=$(printf "#%s %s...\n%sさんありがとうございます!\n%s\n%s" "${PR_NUMBER}" "${PR_TITLE_SHORT}" "${PR_USER}" "${PR_URL}" "${HASH_TAGS}")
        fi

        # GitHub Actionsの出力に設定
        {
          echo "tweet_text<<EOF"
          echo "$TWEET_TEXT"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Post tweet
      run: |
        pnpm exec tsx scripts/post-tweet.ts "${{ steps.generate_tweet.outputs.tweet_text }}"
