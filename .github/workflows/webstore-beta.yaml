name: Webstore BETA Publish

on:
  pull_request:
    types: [edited]

jobs:
  webstore_beta_publish:
    if: |
      github.event.changes.title && startsWith(github.event.pull_request.title, '[v')
    # github.event.pull_request.base.ref == 'master' &&
    # github.event.pull_request.head.ref == 'develop' &&
    runs-on: ubuntu-latest
    env:
      NODE_ENV: beta
      GOOGLEAPI_CLIENT_ID:     ${{ secrets.GOOGLEAPI_CLIENT_ID }}
      GOOGLEAPI_CLIENT_SECRET: ${{ secrets.GOOGLEAPI_CLIENT_SECRET }}
      GOOGLEAPI_REFRESH_TOKEN: ${{ secrets.GOOGLEAPI_REFRESH_TOKEN }}
      CHROMEWEBSTORE_EXTENSION_ID: egkgleinehaapbpijnlpbllfeejjpceb
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    - run: pnpm install
    - run: make beta-release
    - name: Publish to Webstore (BETA)
      run: |
        npx -y tsx scripts/webstore-publish.ts ./release/艦これウィジェット-BETA.zip

  announce_beta_tweet:
    needs: webstore_beta_publish
    if: |
      needs.webstore_beta_publish.result == 'success'
    runs-on: ubuntu-latest
    env:
      NODE_ENV: beta
      X_BOT_API_KEY:             ${{ secrets.X_BOT_API_KEY }}
      X_BOT_API_KEY_SECRET:      ${{ secrets.X_BOT_API_KEY_SECRET }}
      X_BOT_ACCESS_TOKEN:        ${{ secrets.X_BOT_ACCESS_TOKEN }}
      X_BOT_ACCESS_TOKEN_SECRET: ${{ secrets.X_BOT_ACCESS_TOKEN_SECRET }}
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    - run: pnpm install
    - name: Post release announcement tweet
      run: |
        TWEET_TEXT="$(pnpm exec tsx scripts/generate-release-announce.ts --beta)"
        printf 'Generated tweet:\n%s\n' "$TWEET_TEXT"
        pnpm exec tsx scripts/post-tweet.ts "$TWEET_TEXT"
