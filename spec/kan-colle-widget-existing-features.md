# Feature Specification: 艦これウィジェット v4 既存機能

**Feature Branch**: `[docs-existing-features]`  
**Created**: 2025-10-19  
**Last Reviewed**: 2025-10-21  
**Status**: Living Spec  
**Input**: User description: "既存実装の仕様整理"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 別窓起動と継続利用 (Priority: P1)

利用者は拡張ポップアップからプレイ用フレームを選び、艦これ本体を専用ポップアップウィンドウで起動できる。既存ウィンドウがあればフォーカスだけで済み、サイズ・位置・ズームは直近の使用状況が自動復元される。起動後は注入スクリプトによりゲーム iframe へ必要な UI とスタイルが展開される。

**Why this priority**: 艦これプレイ開始の前提であり、別窓が正しく立ち上がらないと他機能が機能しない。

**Independent Test**: ポップアップから各プリセットを選択し、別窓が 2 秒以内に起動またはフォーカスされ、直近サイズが反映されることを確認する。別窓を閉じた後に再度起動し、サイズ・位置が保存されているかを検証する。

**Acceptance Scenarios**:

1. **Given** 拡張がインストール済みでプリセットが表示されている, **When** 利用者が任意のフレームを選択する, **Then** 指定サイズのポップアップウィンドウが生成され注入スクリプトが読込完了後に実行される。
2. **Given** 起動済みの別窓がバックグラウンドで動作している, **When** 利用者が同じフレームを再度起動する, **Then** 既存ウィンドウが前面に出て重複作成が発生しない。
3. **Given** 利用者がウィンドウ位置やサイズを調整した状態で 10 秒以上プレイする, **When** 別窓を閉じて再起動する, **Then** 最終位置とサイズが復元される。

---

### User Story 2 - 自動タイマーと通知管理 (Priority: P1)

遠征・入渠・建造・疲労・戦闘結果などゲーム API を監視し、必要なタイマーを自動登録する。タイマー開始時は開始通知を短時間表示し、完了予定時刻になると Chrome 通知を発火してキューから除去する。タイマーは OCR による残り時間読み取りにも対応し、通知クリック時はゲーム別窓を再表示できる。

**Why this priority**: 遠征や修復の回し忘れ防止が拡張の主要価値であり、通知の精度が直接 UX に影響する。

**Independent Test**: テストアカウントで各 API を順に発火させ、秒単位でキューが登録されること、通知が発火・自動消去されること、完了 API 受信後に通知が掃除されることを記録する。通知をクリックし別窓が開くことも確認する。

**Acceptance Scenarios**:

1. **Given** `/kcsapi/api_req_mission/start` が発生した, **When** 背景ページが API を検知する, **Then** 対応艦隊の遠征タイマーがストレージに登録され開始通知が 6 秒後に消える。
2. **Given** `/kcsapi/api_req_nyukyo/start` または `/kcsapi/api_req_kousyou/createship` が送信された, **When** 背景ページが可視タブをキャプチャして OCR を実行する, **Then** 読み取った `hh:mm:ss` をもとに入渠・建造タイマーが作成される。
3. **Given** `/kcsapi/api_req_map/start` が送信された, **When** 疲労タイマー生成ロジックが実行される, **Then** 指定デッキに 15 分の疲労キューが追加される。
4. **Given** 遠征結果 `/kcsapi/api_req_mission/result` を取得した, **When** 通知管理ロジックが完了通知を確認する, **Then** 対応する遠征通知が残存していれば即時にクリアされる。
5. **Given** タイマー完了時刻を迎え Chrome 通知が発火した, **When** 利用者が通知をクリックする, **Then** 別窓が起動またはフォーカスされ通知がクリアされる。

---

### User Story 3 - ダッシュボードでの状況把握と調整 (Priority: P2)

利用者は専用ダッシュボードを開き、現在時刻・別窓の状態・登録済みタイマー一覧をリアルタイムに確認できる。タイマーの手動編集・削除や新規追加が可能で、疲労キュー専用のビューも提供される。さらにミュート切り替えやスクリーンショット取得をワンクリックで操作できる。

**Why this priority**: 自動登録が失敗した場合のリカバリ手段と進行状況の可視化により、通知機能の信頼性と利便性を補完する。

**Independent Test**: ダッシュボードを 5 分間表示したままにし、時刻表示が 1 秒ごとに更新されること、モーダルからタイマーを編集して即座にビューへ反映されること、ミュート切り替えやスクリーンショットが正常に動作することを確認する。

**Acceptance Scenarios**:

1. **Given** ダッシュボードを開いた, **When** 初期ローディングが完了する, **Then** 現在時刻・別窓情報・全キューが表示され、1 秒ごとに自動再検証される。
2. **Given** タイマー一覧の任意行を選択した, **When** モーダルで予定時刻を更新して保存する, **Then** キューが保存され表示が即時更新される。
3. **Given** 疲労キュー一覧を開いた, **When** 不要な疲労キューの削除を指示する, **Then** 次回ポーリング後も削除状態が維持され通知対象外になる。
4. **Given** 別窓が開いて音声が再生されている, **When** ダッシュボードのミュートボタンを押下する, **Then** タブの音声状態が 1 秒以内に反転し表示アイコンも更新される。
5. **Given** 別窓が開いている, **When** ダッシュボードのカメラボタンを押下する, **Then** 可視領域のスクリーンショットが PNG としてダウンロードされる。

---

### User Story 4 - ゲーム内アシスト UI と安全ガイド (Priority: P2)

ゲーム iframe 内にホバー式のスクリーンショット・ミュートボタンが常駐し、戦闘終了時には大破進撃防止オーバーレイを自動表示する。オーバーレイはクリック回数に応じて更新・解除され、必要に応じて確認ダイアログで強制解除が可能。戦闘開始・母港帰還時は不要なオーバーレイを自動消去する。

**Why this priority**: ゲーム画面上で直接使える安全機能が、遠征周回や戦闘中の事故防止に貢献する。

**Independent Test**: 戦闘を開始してから結果画面に遷移するまでを通し、オーバーレイの表示タイミングと解除動作を確認する。併せて、ゲーム内ボタンでのミュート・スクショ操作がバックグラウンド経由で成功するか検証する。

**Acceptance Scenarios**:

1. **Given** 別窓で艦これが起動している, **When** 戦闘結果 API が完了する, **Then** 指定領域を切り抜いたオーバーレイが 2 秒以内に表示され、クリックに応じて最新画像へ更新される。
2. **Given** オーバーレイが表示されている, **When** 利用者が確認ダイアログを承認する, **Then** オーバーレイが明示的に消え再表示されない。
3. **Given** 戦闘開始や母港復帰を検知した, **When** 背景ページがリセットイベントを発行する, **Then** 既存オーバーレイが確実に除去される。
4. **Given** 利用者がゲーム内ボタンにマウスオーバーした, **When** スクリーンショットボタンを押下する, **Then** オーバーレイが写り込まないよう UI が一時的に非表示になり、撮影完了後に復元される。

---

### User Story 5 - 設定・権限管理と開発情報 (Priority: P2)

利用者はオプションページからフレーム設定の追加・削除・初期化を行い、自分のディスプレイ環境に合わせた別窓を登録できる。最新リリース情報や告知は JSON から読み込み一覧表示される。

**Why this priority**: 安全な権限管理とユーザー自身によるカスタマイズが利用継続の鍵であり、リリース情報の透明性も信頼性向上に直結する。

**Independent Test**: オプションページを開き、(1) 別窓を新規登録して再表示されること、(2) リリースノートのリンクが外部リポジトリへ遷移すること、を確認する。

**Acceptance Scenarios**:

1. **Given** 別窓を起動している, **When** 「今開いている別窓を新規設定として登録」を選択する, **Then** 現在のサイズと位置が新規フレームとして保存され一覧へ即時追加される。
2. **Given** フレーム設定一覧が表示されている, **When** 保護されていない設定を削除する, **Then** リストから消え再読み込み後も復活しない。
3. **Given** リリースノート一覧が表示されている, **When** 任意のコミットリンクをクリックする, **Then** 対応する GitHub コミットページが新規タブで開く。

---

### Edge Cases

- OCR が `hh:mm:ss` 形式以外を返した場合、タイマー登録が行えずユーザーに再入力手段が提示されないため、ダッシュボードから手動登録できる導線を維持する必要がある。
- `Queue` に過去時刻のレコードが大量に残存すると、キュー監視が同時通知を乱発する恐れがあるため、ダッシュボードから定期的に整理できることが不可欠である。
- 別窓の検索に失敗した状態で通知クリック・ミュート操作・スクリーンショットを要求すると処理失敗が発生する。ユーザーに原因が伝わらないため、エラー時はガイド表示か再起動導線が必要。
- 戦闘終了イベントのメッセージが競合しオーバーレイが残留した場合、ゲーム内オーバーレイがクリックで消せることが最後の安全弁となる。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはポップアップから選択されたフレーム設定で艦これ専用ポップアップウィンドウを起動し、既存ウィンドウがある場合は再利用しなければならない。
- **FR-002**: システムは専用ウィンドウの位置とサイズを 10 秒間隔で記録し、次回起動時に復元しなければならない。
- **FR-003**: システムは別窓起動時にゲーム iframe へ操作ボタンと大破防止機能を提供するスクリプト・スタイルを確実に注入しなければならない。
- **FR-004**: システムは艦これ API リクエストを監視し、遠征・入渠・建造・疲労・戦闘結果に対応するタイマーエントリを即時に生成・更新しなければならない。
- **FR-005**: システムは入渠・建造タイマー生成時にスクリーンショットを撮影し、OCR で取得した残り時間をもとに予定時刻を算出しなければならない。
- **FR-006**: システムはタイマー登録時の開始通知を 6 秒以内に自動消去し、完了判定後は関連通知とキューを確実に除去しなければならない。
- **FR-007**: システムはダッシュボードで全タイマーの閲覧・編集・削除・手動追加を提供し、表示内容を 1 秒周期で最新化しなければならない。
- **FR-008**: システムはダッシュボードおよびゲーム内 UI からのミュート切替・スクリーンショット要求に応答し、処理結果を UI に即時反映しなければならない。
- **FR-009**: システムはオプションページでフレーム設定の一覧表示・削除・初期化・現在ウィンドウからの新規作成を提供しなければならない。
- **FR-010**: システムは通知クリック時にゲーム別窓を起動またはフォーカスし、通知をクリアしなければならない。
- **FR-011**: システムはリリースノート JSON を読み込み、バージョン・告知・コミットリンクをオプションページへ表示しなければならない。

### Key Entities *(include if feature involves data)*

- **Frame**: 別窓起動に必要な位置・サイズ・ URL・保護フラグを保持する永続データ。プリセットとユーザー定義の両方を扱い、記憶用の特別エントリ（`__memory__`）を持つ。
- **Queue**: 通知キューを表す永続データ。種別（遠征・入渠・建造・疲労など）とパラメータ、予定時刻 (ms) を保持し、残り時間計算や実行タイミング判定を担う。
- **Entry オブジェクト** (Mission / Recovery / Shipbuild / Fatigue): 各キュー種別に固有の通知メッセージと ID スキームを提供し、開始・完了の通知内容を組み立てる。
- **ReleaseNoteObject**: リファレンスリポジトリ、リリース履歴、告知情報、コミット一覧を含むデータ構造。オプションページの開発情報セクションで利用する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ポップアップ操作から 2 秒以内に別窓が起動またはフォーカスされ、直近の位置・サイズが 95% 以上のケースで復元されること。
- **SC-002**: 遠征・入渠・建造 API 受信から 1 秒以内に対応するタイマーがストレージに作成され、完了判定後 1 秒以内に通知が消去されること。
- **SC-003**: ダッシュボード滞在中、現在時刻表示とキュー一覧が 1 秒ごとに更新されることを 5 分連続で確認し、遅延が 500 ms を超えないこと。
- **SC-004**: ダッシュボードまたはゲーム内からのミュート切替・スクリーンショット操作が 1 秒以内に完了し、失敗率が 2% 未満であること。

## 窓内アクションメニュー (InAppActionButtons)

### 目的と配置

- ゲーム別窓全体のトップレベル DOM に常駐し、スクリーンショットとタブの
  ミュート切替を即座に提供する補助メニュー。
- `src/injection/dmm.ts` が `play.games.dmm.com` 側へ注入された直後に
  `InAppActionButtons.create()` を呼び出し、1 ウィンドウにつき 1 インスタンスだけ
  を生成する。
- コンテナは `id="kcw-inapp-action-buttons"` を持つ `div` で、トップページの
  `document.body` 右上へ固定配置。初期不透明度は 0%、ホバー時に 80% まで
  アニメーション表示される。

### UI 構成

- コンテナ内部には 2 つのボタンが横並びで生成され、右から順にミュート、左が
  スクリーンショット。
- ボタンは背景色白、ボーダー無し、フォントサイズ 32px。マウスオーバーで
  カーソルがポインタになる。
- ミュートボタンはタブの音声状態に応じてスピーカー記号
  (U+1F50A/ミュート解除) とスピーカー消音記号 (U+1F507/ミュート) を切り替える。
- スクリーンショットボタンはカメラ記号 (U+1F4F7) を表示する。

### 操作シーケンス

- スクリーンショット
  - クリック即時にコンテナを一時的に非表示 (`display:none`) にし、
    `/screenshot` メッセージをバックグラウンドへ送信する。
  - 処理完了まで 100ms の待機を挟んでからコンテナ表示を復元し、撮影画像への
    写り込みを抑制する。
- ミュート切替
  - クリックで `/mute:toggle` メッセージを送信し、背景ページが `chrome.tabs`
    API で当該タブの `muted` 状態をトグルする。
  - 応答として受け取ったタブ情報の `mutedInfo.muted` を参照し、ボタン表示中の
    記号を更新する。

### 制約と依存

- InAppActionButtons は Chrome 拡張 API を前提とし、`sender.tab` が取得できない
  メッセージ経路では動作しない。
- トップレベルの `dmm.ts` が再注入されても `create()` が既存インスタンスを
  再利用し、重複生成を防ぐ。
- 画面内の他要素を阻害しないよう、背景は半透明白でクリック透過はしないが、
  ミュートや撮影以外の機能を提供しない。

### テスト観点

- トップレベルページにマウスを乗せた際、コンテナの不透明度が 0%→80% に変化し、
  フォーカスを外すと 0% に戻ること。
- スクリーンショット操作で撮影した画像にメニューが写り込まないこと、および
  ダウンロードファイルが PNG 形式で保存されること。
- ミュート切替後に Chrome のタブ音量状態が即時反映され、記号表示が状態と一致
  すること。
- 連続クリック時にもエラーが発生せず、メッセージ送信が正しいタブに紐付くこと。
